# デプロイ確認とスコープ（配送対応表示）について

## 1. デプロイが本当にできているか確認する方法

### 1.1 Partners ダッシュボードで確認（確実）

1. **Shopify Partners** にログインする  
   https://partners.shopify.com  
2. **アプリ** → **Location Stock**（または location-stock-indicator）を開く  
3. **バージョン / Versions** または **リリース履歴** を開く  
4. 一覧に **location-stock-7**（または直近のバージョン番号）があり、日時がデプロイ実行時刻になっていればデプロイは反映済みです。

直前のデプロイでは次の URL が表示されていました（アプリ ID は環境により異なります）:
- `https://dev.shopify.com/dashboard/129964780/apps/299956109313/versions/869553995777`

### 1.2 コマンドで確認

```bash
cd /Users/develop/ShopifyApps/location-stock-indicator
npx shopify app deploy --force
```

- **「New version released to users」** と出て exit code 0 なら、その時点でデプロイは成功しています。
- 同じコマンドを再度実行すると、新しいバージョン番号（例: location-stock-8）が作成されます。

---

## 2. 「配送対応」「ローカルデリバリー対応」が表示されない理由

デプロイで **コード** と **スコープ設定（read_shipping）** はアプリ側に反映されますが、**ストア側の「インストール時の権限」** は別です。

- ストアにアプリをインストールしたときの **OAuth トークン** に、当時のスコープ（read_shipping なし）が記録されています。
- デプロイ後にスコープを追加しても、**既存のインストールは自動では更新されません**。
- そのため、管理画面のロケーション一覧で `deliveryProfiles` を呼んでも、権限不足でデータが取れず、「配送対応」「ローカルデリバリー対応」が表示されない状態になります。

### 2.1 対応方法（ストアで新しいスコープを承認する）

次のいずれかで、**そのストア** に `read_shipping` を付与したトークンに更新してください。

**方法 A: アプリを開いたときの「権限の更新」で承認**

1. ストアの管理画面で **Location Stock** を開く。
2. 「新しい権限を承認する」などの画面が出たら **承認** する。
3. 出ない場合は、一度アプリを閉じ、**アプリ一覧から再度開き直す** と出ることがあります。

**方法 B: アプリのアンインストール → 再インストール**

1. 設定 → アプリと販売チャネル → Location Stock → アンインストール。
2. 同じアプリを再度インストールし、インストール時の権限画面で **read_shipping を含むスコープ** を承認する。

**方法 C: 開発ストアで dev 実行中の場合**

- `shopify app dev` で開いている場合は、**dev 用のインストール** が古いトークンのままの可能性があります。
- そのストアでも上記 A または B を行い、「権限の更新」または再インストールで新しいスコープを承認してください。

---

## 3. dev のプレビューのままだと確認できない？

**コードの変更** は dev プレビュー（`shopify app dev`）でも確認できます。

ただし **「配送対応」「ローカルデリバリー対応」の表示** は、**API の権限（read_shipping）** に依存します。

- dev で開いているストアの **インストール** が、まだ `read_shipping` を付与されていない古いトークンを使っている場合、`deliveryProfiles` は失敗または空になり、対応バッジは出ません。
- そのため **「dev のプレビューのままだと確認できない」** のではなく、**「dev でも、そのストアで新しいスコープを承認すれば確認できる」** です。
- 手順は上記 2.1 の A または B を、**dev で使っている開発ストア** に対して行ってください。

---

## 4. デプロイは公開用と自社用に分けて実行しなくて問題ない？

現在のリポジトリでは:

- **shopify.app.toml** と **shopify.app.public.toml** の **client_id が同じ**（`1758d63a004d7f7d99afe5bf334d1f48`）です。
- つまり **1 つの Partners アプリ** を、名前や設定の違いで 2 つの toml から見ているだけです。
- デプロイ時には **どちらか一方が「デフォルト」** として使われ（直前のデプロイでは `shopify.app.public.toml`）、**同じアプリの同じバージョン** が 1 つリリースされます。

このため:

- **公開用と自社用で「同じ 1 つのアプリ」** を使う場合は、**デプロイを 1 回実行すれば十分**です。分けて実行する必要はありません。
- **公開用と自社用で「別々の Partners アプリ」（別 client_id）** を使う場合は、アプリごとに toml を分け、それぞれの設定で **別々にデプロイ** する必要があります。

現在の構成では **1 アプリ・1 デプロイ** で問題ありません。

---

## 5. ローカルデリバリー対応が表示されない場合

「配送対応」は出るが「ローカルデリバリー対応」だけ出ない場合、**配送方法の名前**で判定しているためです。

- Shopify の配送プロファイル API には「ローカルデリバリー」かどうかを示す `methodType` などのフィールドが **ありません**。
- そのため、次の **2 つ** の名前で判定しています。
  1. **ゾーン名（zone.name）** … 管理画面の「Local Delivery」（最大○km）と表示される名前。ここが「Local delivery」等ならローカルデリバリーと判定。
  2. **配送方法名（methodDefinitions.name）** … ゾーン内の個別配送方法の名前。
- いずれかに次のキーワードが含まれる場合に「ローカルデリバリー対応」としています。
  - `local` / `ローカル` / `local delivery` / `localdelivery`
  - `same-day` / `sameday` / `same day` / `当日` / `近距離`

**対処法**

- 管理画面の **設定 → 配送と配達** で、ローカルデリバリーのゾーン名または配送方法の名前を上記のいずれかを含む名前にする（例: 「ローカルデリバリー」「Local delivery」「当日配達」「近距離配達」「半径」）。
- どうしても別の名前を使う場合は、開発者に依頼して `app.locations.jsx` と `apps.location-stock.js` の `isLocalDeliveryMethodName` にその名前のキーワードを追加してもらう。

**まだ表示されない場合のデバッグ**

- ロケーション設定ページを開くときに URL に **`?debug=delivery`** を付けて読み込む（例: `https://.../app/locations?debug=delivery`）。
- サーバー（ターミナルまたはログ）に `[location-stock] deliveryProfiles:`（プロファイル数・グループ数）、`deliveryProfiles debug:`（各グループのゾーン名・ロケーションID）、`deliveryFlags map:` が出力されます。
- **ロケーション ID が debug に一切出てこない**場合 → そのロケーションは「配送プロファイルのロケーショングループ」に含まれていません。Shopify の **設定 → 配送と配達** で、該当ロケーションを配送プロファイルに割り当て、かつローカルデリバリーのゾーン（名前が「Local Delivery」等）を作成する必要があります。
- ロケーション ID は出ているが **ゾーン名にキーワードが含まれていない**場合 → ゾーン名をキーワードに合わせるか、キーワードを追加してください。

---

## 6. バックエンドの環境変数（missing_admin_client 対策）

App Proxy で「管理画面 API クライアントの初期化に失敗しました」となる場合、**デプロイ先の環境変数**が不足している可能性があります。

### 6.1 必要な環境変数（目安）

| 変数名 | 説明 | 備考 |
|--------|------|------|
| `SHOPIFY_API_KEY` | アプリの API キー（Client ID） | Partners ダッシュボードのアプリ → クライアント ID |
| `SHOPIFY_API_SECRET` | アプリの API シークレット | 同じく「クライアントのシークレット」 |
| `SCOPES` または `SHOPIFY_API_SCOPES` | スコープ一覧（カンマ区切り） | 例: `read_products,read_inventory,read_locations,read_shipping,...` |

このほか、**セッション保存**（Prisma 等）用の `DATABASE_URL` や、デプロイ先が求める変数（例: Render の `RENDER_EXTERNAL_URL`）も必要に応じて設定します。

### 6.2 確認手順（例: Render）

1. Render の **Dashboard** → 対象 **Web Service** を開く。
2. **Environment** タブで、上記の変数が **すべて設定されているか** 確認する。
3. 値を変更した場合は **Save Changes** のあと、サービスが再デプロイされるのを待つ。
4. 再発する場合は、**Logs** で起動時エラーや `[location-stock]` のログを確認する。

### 6.3 販売用アプリとカスタムアプリで別サービス／別環境変数を使う場合

- **販売用**（例: `shopify.app.toml` でデプロイ）と **カスタム用**（例: `shopify.app.ciara.toml`）で、**別々の Render サービス**（別の Web Service）を用意している場合:
  - それぞれのサービスで、**そのアプリの** `SHOPIFY_API_KEY` / `SHOPIFY_API_SECRET` を設定する（Client ID が異なるため、キーとシークレットも異なります）。
  - スコープも、そのアプリで要求しているスコープ一覧に合わせて設定する。
- **同じコードベース**で toml だけ切り替えてデプロイしている場合でも、**ホスト先が 1 つ**なら環境変数は 1 セットでよいことが多いです。**ホスト先が 2 つ**（販売用・カスタム用で別 URL）なら、それぞれの環境変数を上記のとおり確認してください。

### 6.4 エラー時のログ確認

- **App Proxy** のエラー時は、サーバーログに `[location-stock] App Proxy error` とともに **shop / variantId / code / message** が JSON で出力されます。どのストア・どの商品で失敗したかをここで確認できます。
- **管理画面**（ロケーション設定・在庫表示設定）の API エラー時は、`[location-stock]` プレフィックス付きで **shop（ストアドメイン）** と **ルート名** がログに含まれるようにしています。ログから「どのストアのどの操作でエラーになったか」を特定してください。

---

## 7. まとめ

| やりたいこと | やること |
|--------------|----------|
| デプロイできたか確認する | Partners のアプリ → バージョン一覧で最新バージョンと日時を確認 |
| 配送対応・ローカルデリバリー対応を表示する | 各ストアで「権限の更新」または再インストールして read_shipping を承認 |
| dev で確認する | 開発ストアでも上記の権限更新を行えば dev プレビューで表示可能 |
| 公開用・自社用のデプロイ | 同じアプリなら 1 回のデプロイでよい（別アプリなら別デプロイ） |
| ローカルデリバリー対応が表示されない | 配送方法名に「local」「ローカル」「当日」「近距離」などを含める（セクション 5 参照） |
| missing_admin_client が出る | デプロイ先の環境変数（SHOPIFY_API_KEY / SHOPIFY_API_SECRET / SCOPES）を確認（セクション 6 参照） |
