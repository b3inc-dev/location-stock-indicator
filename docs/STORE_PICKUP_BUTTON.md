# 「この店舗で受け取る」ボタンと Shopify の店舗受け取りの流れ

## ボタンをタップしたときに Shopify で機能として成立させるには

Shopify の**店舗受け取り（Local Pickup）**は、次の流れで成立します。

1. **カートに商品を追加する**（商品ページで「カートに追加」など）
2. **チェックアウトに進む**
3. **チェックアウト画面で「配送方法」のところで「店舗で受け取る」を選ぶ**
4. **受け取り店舗（ロケーション）を一覧から選択する**
5. 注文を確定する

つまり、「どの店舗で受け取るか」の**最終選択はチェックアウト画面**で行われます。商品ページの在庫表示ブロックで「この店舗で受け取る」ボタンを押した時点では、**受け取り店舗を事前指定する公式 API はありません**。

---

## このアプリのボタンの役割

- ボタンをクリックすると、**カスタムイベント `location-stock-order-pick`** が発火したあと、**スニペット側で現在のバリアントを 1 個カートに追加**する処理がデフォルトで実行されます。
- **管理画面（ロケーション設定 → 店舗受取設定）**で「ボタンタップ後にチェックアウトまでリダイレクトする」にチェックを入れると、カートに追加したあとそのままチェックアウトページへ移動します。チェックを入れない場合はカートに追加するだけで、顧客はいつでもカートやチェックアウトに進めます。
- イベントの `detail` に `locationId` と `locationName` が入っているため、**テーマ側**でこのイベントをリッスンして独自の動きを追加することもできます。

### デフォルトの動き（スニペット内で実装済み）

- ボタンタップ → イベント発火 → **カートに 1 個追加** → （オプション）チェックアウトへリダイレクト。
- チェックアウト画面で「店舗で受け取る」と受け取り店舗を選んでもらえば成立します。

### パターン B: テーマ側で受け取り店舗ページへリンク

- 「この店舗で受け取る」を、**その店舗の受け取り説明ページ**（例: `/pages/pickup-store-123`）へのリンクとして扱う。
- そのページで「カートに追加」してからチェックアウトに進んでもらう。

### パターン C: イベントだけ発火し、何もしない

- テーマで `location-stock-order-pick` を購読していない場合は、**ボタンを押しても見た目上だけ**で、画面遷移やカート操作は発生しません。
- 必要に応じてテーマの JavaScript で上記 A または B を実装する。

---

## テーマでイベントを受け取る例

カートに追加するだけの例（リダイレクトなし）。必要なら `.then(...)` 内で `window.location.href = "/cart";` や `"/checkout"` を追加できます。

```javascript
document.addEventListener("location-stock-order-pick", function (event) {
  var locationId = event.detail && event.detail.locationId;
  var locationName = event.detail && event.detail.locationName;
  var variantId = document.querySelector('form[action*="/cart/add"] [name="id"]');
  if (variantId && variantId.value) {
    fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: [{ id: variantId.value, quantity: 1 }] }),
    })
      .then(function () {
        // カートに追加したあとの処理（任意）。例: カートページへ飛ばす / チェックアウトへ飛ばす / 何もしない
        // window.location.href = "/cart";
      })
      .catch(function () { /* エラー時 */ });
  }
});
```

---

## まとめ

| 質問 | 回答 |
|------|------|
| ボタン押下で「この店舗で受け取る」が自動で選ばれる？ | いいえ。チェックアウトで店舗を選ぶのが Shopify の仕様です。 |
| 機能として成立させるには？ | ボタンで「カートに追加」し、顧客がカート／チェックアウトに進んだタイミングで「店舗で受け取る」と店舗を選んでもらえば成立。 |
| アプリのボタンは何をしている？ | イベント発火のあと、スニペット内でカートに追加。管理画面で「チェックアウトまでリダイレクト」をONにするとチェックアウトへ飛ばす。テーマ側でイベントを購読して独自処理も可能。 |
